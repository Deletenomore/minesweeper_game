<!-- /*
 * Code inspired by the YouTube tutorial: "Minesweeper Game Tutorial"
 * YouTube video: https://www.youtube.com/watch?v=AfhfAxKFP-s
 * GitHub repository: https://github.com/ImKennyYip/Minesweeper
 * Author: ImKennyYip
 * This code will be used for Fresno State CSCI130 project only .
 */ -->
 <!DOCTYPE html>
 <html lang="en">
   <head>
     <title>START THE GAME</title>
     <meta charset="UTF-8"> <!-- Fixed charset typo -->
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <link rel="stylesheet" href="CSS/nav.css"/>
     <link rel="stylesheet" href="CSS/game.css"/>
     
   </head>
   <body>
     <nav>
       <ul>
         <li><a href="index.html">HOME</a></li>
         <li><a href="login.html">LOGIN</a></li>
         <li><a href="game.html">GAME</a></li>
         <li><a href="leaderboard.html">LEADERBOARD</a></li>
         <li><a href="help.html">HELP</a></li>
         <li><a href="contact.html">CONTACT</a></li>
       </ul>
     </nav>
 
     <h1>Let's Play the Minesweeper Game!</h1>
    <h3>Player: <span id="gamer" name = "gamer"></span></h3>
     <h4>Mines: <span id="mine_count">0</span></h4>

 
     <div id="gameboard" style="display: none;"></div>
    
     <br>

     <button id="easy" onclick="setLevel('easy')">EASY</button>
     <button id="meidum" onclick="setLevel('intermediate')">INTERMEDIATE</button>
     <button id="hard" onclick="setLevel('hard')">HARD</button>

     <!-- Sound Elements -->
     <audio id="backgroundMusic" loop>
      <source src="sounds/background.mp3" type="audio/mpeg">
      Your browser does not support the audio element.
    </audio>
    <audio id="clickSound">
      <source src="sounds/click.mp3" type="audio/mpeg">
      Your browser does not support the audio element.
    </audio>
    <audio id="mineSound">
      <source src="sounds/mine.mp3" type="audio/mpeg">
      Your browser does not support the audio element.
    </audio>
    <audio id="gameOverSound">
      <source src="sounds/gameover.mp3" type="audio/mpeg">
      Your browser does not support the audio element.
    </audio>
    <audio id="winSound">
      <source src="sounds/win.mp3" type="audio/mpeg">
      Your browser does not support the audio element.
    </audio>

    <!-- Volume Control -->
    <div>
      <label for="backgroundMusicVolume">Background Music Volume:</label>
      <input type="range" id="backgroundMusicVolume" min="0" max="1" step="0.1" value="0.5">
      
      <label for="sfxVolume">Sound Effects Volume:</label>
      <input type="range" id="sfxVolume" min="0" max="1" step="0.1" value="0.5">
    </div>

     
     <script type="text/javascript" defer>
      // Global variable sections
      var userName = '';
      var gameboard = [];
      var rows=0;
      var cols = 0;

      var mineCount = 0;
      var minesLocation = [];

      var tilesClicked = 0; //goal to click all tiles except the ones containing mines
      var flagStatus = false;

      var gameOver = false;


      //Member functions for the game

      function setLevel(level){
        document.getElementById("gameboard").style.display = "flex";
        if(level === 'easy'){
          rows = 8;
          cols = 8;
          mineCount = 8;
          document.getElementById("gameboard").style.width = "400px";
          document.getElementById("gameboard").style.height = "400px";
          
        } else if (level === 'intermediate'){
          rows = 16;
          cols = 16;
          mineCount = 40;
          document.getElementById("gameboard").style.width = "640px";
          document.getElementById("gameboard").style.height = "640px";
        }else if(level === 'hard'){
          rows = 16;
          cols = 30;
          mineCount = 99;
          document.getElementById("gameboard").style.width = "900px";
          document.getElementById("gameboard").style.height = "480px";
        }
        startGame()
      }

      // window.onload = function(){
      //   startGame();
      // }
      
      function startGame(){
        //Play background music
        if(backgroundMusic){
          backgroundMusic.currentTime = 0;
          backgroundMusic.play();
        }

        gameboard = []; // Reset the gameboard array
        const gameboardElement = document.getElementById("gameboard");
        gameboardElement.innerHTML = ""; // Clear existing tiles
        document.getElementById("mine_count").innerText = mineCount;

       
        const tileWidth = parseInt (gameboardElement.style.width) / cols -2; // Calculate dynamic tile width
        console.log(tileWidth);
        const tileHeight = parseInt(gameboardElement.style.height)/ rows -2; // Calculate dynamic tile height
        console.log(tileHeight);

        setMines();
        //populate the board
        for(let r=0;r<rows;r++){
          let row = [];
          for(let c = 0;c<cols;c++){
            let tile = document.createElement("div");
            tile.id=r.toString()+"-"+c.toString();
            tile.style.width = `${tileWidth}px`;
            tile.style.height = `${tileHeight}px`;
            tile.style.fontSize = `${tileWidth / 2}px`; // Adjust font size dynamically
            tile.addEventListener('contextmenu', setFlag);
            tile.addEventListener('click', clickTile);
            document.getElementById("gameboard").append(tile);
            row.push(tile);

          }
          gameboard.push(row);
        }
        console.log(gameboard);
      }

      // Function to handle the flag by right click
      function setFlag(event) {
        event.preventDefault(); // Prevent default right-click menu
        let tile = this;
          if (tile.innerText === "") {
            tile.innerText = "ðŸš©"; // Add flag on right-click
            flagStatus = true;
          } else if (tile.innerText === "ðŸš©") {
            tile.innerText = ""; // Remove flag on right-click
            flagStatus = false;
          }
          return;

      }

        //Function to randomly assign the mine location
    function setMines(){
      let mineLeft = mineCount;
      while(mineLeft>0){
      let r = Math.floor(Math.random()*rows);
      let c =Math.floor(Math.random()*cols);
      let id = r.toString() +"-"+c.toString();

      if(!minesLocation.includes(id)){
        minesLocation.push(id);
        mineLeft -= 1;
      }

      }
    }


    function revealMines(){
       // Play game over sound
       if (gameOverSound) {
          gameOverSound.play();
        }

        // Stop background music
        if (backgroundMusic) {
          backgroundMusic.pause();
        }

      for(let r = 0; r<rows; r++){
        for(let c = 0; c<cols; c++){
          let tile = gameboard[r][c];
          if (minesLocation.includes(tile.id) ){
            tile.innerText = "ðŸ’£";
            tile.style.backgroundColor = "red";
          }
        }
      }
    }

    //Function to handle the event when click the tile.
    function clickTile(){

      // Play click sound
      if (clickSound) {
          clickSound.currentTime = 0;
          clickSound.play();
        }


      if(gameOver || this.classList.contains("tile-clicked")){
        return;
      }

      let tile = this;
      if(tile.innerText === ""){
      if(minesLocation.includes(tile.id)){
        // Play mine hit sound
        if (mineSound) {
          mineSound.play();
        }

        alert("GAME OVER");
        gameOver = true;
        revealMines();
        return;
      }

      let coords = tile.id.split("-"); //"0-0" -> ["0","0"]
      let r = parseInt(coords[0]); //coordinate for row
      let c = parseInt(coords[1]); // coordinate for column
      checkMine(r, c);
    }

    };

    //Function to check if the tile contains a mine
    function checkMine(r,c){
      if(r<0|| r>=rows|| c<0|| c >=cols){
        return;
      }
      if(gameboard[r][c].classList.contains("tile-clicked")){
        return;
      }
      gameboard[r][c].classList.add("tile-clicked")
      tilesClicked += 1;

      let mineFound = 0;

      //check top 3 cell
      mineFound += checkTile(r-1, c-1); //top left
      mineFound += checkTile(r-1, c); //top 
      mineFound += checkTile(r-1, c+1); //top right

      //check lef and right cells
      mineFound += checkTile(r, c-1); //left
      mineFound += checkTile(r, c+1); //right

      //check bottom 3 cells
      mineFound += checkTile(r+1, c-1); //buttom left
      mineFound += checkTile(r+1, c); //buttom
      mineFound += checkTile(r+1, c+1); //buttom  right

      if(mineFound>0){
        gameboard[r][c].innerText = mineFound;
        gameboard[r][c].classList.add("x"+mineFound.toString());

      }else { //recursively check the neighbor tiles until the mineFound >0
   
          //check top 3 cell
       checkMine(r-1, c-1); //top left
       checkMine(r-1, c); //top 
       checkMine(r-1, c+1); //top right

      //check lef and right cells
      checkMine(r, c-1); //left
      checkMine(r, c+1); //right

      //check bottom 3 cells
      checkMine(r+1, c-1); //buttom left
      checkMine(r+1, c); //buttom
      checkMine(r+1, c+1); //buttom  right
      }
      
      if(tilesClicked == rows*cols-mineCount){
        document.getElementById("mine_count").innerText = "Congratulations! You Won! Mines Cleared";
        gameOver = true;
        // Play win sound
        if (winSound) {
          winSound.play();
        }

        // Stop background music
        if (backgroundMusic) {
          backgroundMusic.pause();
          }
      }
    } 

    function checkTile(r,c){
      if(r<0|| r>=rows|| c<0|| c >=cols){
        return 0;
      }
      if(minesLocation.includes(r.toString()+"-"+c.toString())){
        return 1;
      }
      return 0;

    }

    //Sound section
    var backgroundMusic = null;
    var clickSound = null;
    var mineSound = null;
    var gameOverSound = null;
    var winSound = null;

    function initializeSounds(){
      backgroundMusic = document.getElementById('backgroundMusic');
      clickSound = document.getElementById('clickSound');
      mineSound = document.getElementById('mineSound');
      gameOverSound = document.getElementById('gameOverSound');
      windSound = document.getElementById('windSound');

      //Set up volumn controls
      const backgroundMusicVolume = document.getElementById('backgroundMusicVolume');
      const sfxVolume = document.getElementById('sfxVolume');

      backgroundMusicVolume.addEventListener('input', function(){
        backgroundMusic.volume = this.value;
      });

      sfxVolume.addEventListener('input', function(){
        clickSound.volume = this.value;
        mineSound.volume = this.value;
        gameOverSound.volume = this.value;
        winSound.volume = this.value;
      });
    }

    //Initialize sounds when the page loads
    window.addEventListener('load', initializeSounds);

  </script>
 
   </body>
   
 </html>
 